<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>填写借款单</title>
	<meta id="viewport" name="viewport"
	content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="stylesheet" type="text/css" href="https://res.wx.qq.com/open/libs/weui/1.1.0/weui.min.css">
  <link rel="stylesheet" type="text/css" href="./css/flex.css">
  <link rel="stylesheet" type="text/css" href="./css/base.css">
  <link rel="stylesheet" type="text/css" href="./css/borrowBillDetail.css">
  <style>
    .canvas-container {
      width: 100%;
      height: 200px;
    }
    .weui-cells:before{
      display: none;
    }
  </style>
  <script src="./js/jquery.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/base.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/vue.js" type="text/javascript" charset="utf-8"></script>
  <script src="./js/fastclick.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
  <div id="app" v-cloak>
    <div class="w-container" flex="box:last dir:top">
      <!-- 主区域 start -->
      <div class="w-main">
        <form class="weui-cells weui-cells_form" id="signRegisterForm">
          <div class="weui-cell">
            <div class="weui-cell__hd required"><label for="" class="weui-label">单据日期</label></div>
            <div class="weui-cell__bd">
              <input class="weui-input" type="date" v-model="formData.djrq">
            </div>
          </div>

          <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd required">
              <label for="" class="weui-label">银行账号</label>
            </div>
            <div class="weui-cell__bd">
              <select class="weui-select" name="select2" v-model="formData.bankaccount">
                <option value="1">广发 0817</option>
                <option value="2">农业 9770</option>
              </select>
            </div>
          </div>

          <div class="weui-cell">
            <div class="weui-cell__hd required"><label class="weui-label">借款人</label></div>
            <div class="weui-cell__bd">
              <input class="weui-input" :value="formData.psnname" readonly>
            </div>
          </div>

          <div class="weui-cell">
            <div class="weui-cell__hd required"><label class="weui-label">借款部门</label></div>
            <div class="weui-cell__bd">
              <input class="weui-input" :value="formData.jdeptname" readonly>
            </div>
          </div>

          <div class="weui-cell weui-cell_select weui-cell_select-after">
            <div class="weui-cell__hd required">
              <label for="" class="weui-label">承担部门</label>
            </div>
            <div class="weui-cell__bd">
              <select class="weui-select" name="select2" v-model="formData.deptname">
                <option value="工程部">工程部</option>
                <option value="财务部">财务部</option>
              </select>
            </div>
          </div>

          <div class="weui-cell">
            <div class="weui-cell__hd required"><label class="weui-label">借款事由</label></div>
            <div class="weui-cell__bd">
              <textarea class="weui-textarea" placeholder="请输入借款事由" v-model="formData.defitem2" rows="2"></textarea>
            </div>
          </div>

          <div class="weui-cell">
            <div class="weui-cell__hd required"><label class="weui-label">借款金额</label></div>
            <div class="weui-cell__bd">
              <input class="weui-input" v-model="formData.amount">
            </div>
          </div>
          <div class="weui-cell">
            <div class="weui-cell__hd required">
              <label class="weui-label" style="width: 95px;">借款人签名</label>
            </div>
            <div class="weui-cell__bd"></div>
            <div class="weui-cell__ft">
              <a href="javascript:;" class="weui-btn weui-btn_mini weui-btn_default"  @click.stop="handleClearClick()">重签</a>
            </div>
          </div>
          <div class="canvas-container">
            <canvas id="canvas"></canvas>
          </div>
        </form>
        <img :src="signBase64" alt="">
      </div>
      <!-- 主区域 end -->
      <div class="w-footer weui-form-preview__ft">
        <template v-if="!isLoading && !hasError">
          <a class="weui-form-preview__btn weui-form-preview__btn_primary w-operation-btn" href="javascript:void(0)" @click="isOperationShow = true">确认借款</a>
        </template>
        <a v-else-if="hasError" href="javascript:void(0)" class="weui-btn weui-btn_default weui-btn_loading" @click="getDetail"><i class="weui-icon-warn"></i>请求错误，点击这里重试</a>
        <a v-else href="javascript:void(0)" class="weui-btn weui-btn_default weui-btn_loading"><i class="weui-loading"></i>数据加载中</a>
      </div>
    </div>
  </div>
  <script>
    var draw;
    var preHandler = function(e){e.preventDefault();}
    class Draw {
      constructor(el, width, height) {
        this.el = el
        this.width = width;
        this.height = height;
        this.canvas = document.getElementById(this.el);

        this.canvas.setAttribute('width', this.width);
        this.canvas.setAttribute('height', this.height);

        this.markCanvas = document.createElement('canvas');
        this.markCanvas.setAttribute('width', 130);
        this.markCanvas.setAttribute('height', 80);
        this.markCanvas.style.display = 'none';

        document.getElementsByTagName('body')[0].appendChild(this.markCanvas);

        var mctx = this.markCanvas.getContext('2d');

        mctx.font = '20px 黑体';  
        mctx.rotate(-20 * Math.PI / 180);
        mctx.fillStyle = 'rgba(100, 100, 100, 0.1)';
        mctx.fillText('众星软件', -10, 60);
        mctx.rotate(20 * Math.PI / 180);

        this.cxt = this.canvas.getContext('2d');

        this.stage_info = this.canvas.getBoundingClientRect();

        // console.log('stage_info', this.stage_info);
        this.path = {
          beginX: 0,
          beginY: 0,
          endX: 0,
          endY: 0
        }
      }

      renderMark() {

        this.cxt.fillStyle = this.cxt.createPattern(this.markCanvas, 'repeat');
        this.cxt.rect(0, 0, this.width, this.height);
        this.cxt.fill();
      }

      init(btn) {
        var that = this;

        this.canvas.addEventListener('touchstart', function(event) {
          document.addEventListener('touchstart', preHandler, false);
          that.drawBegin(event)
        })
        this.canvas.addEventListener('touchend', function(event) {
          document.addEventListener('touchend', preHandler, false);
          that.drawEnd();
        });
        this.clear(btn);
      }

      drawBegin(e) {
        var that = this;
        window.getSelection() ? window.getSelection().removeAllRanges() : document.selection.empty();
        this.stage_info = this.canvas.getBoundingClientRect();
        this.cxt.strokeStyle = "#000";
        this.cxt.lineWidth = 3;
        this.cxt.beginPath();
        this.cxt.moveTo(
          e.changedTouches[0].clientX - this.stage_info.left,
          e.changedTouches[0].clientY - this.stage_info.top
        );
        this.path.beginX = e.changedTouches[0].clientX - this.stage_info.left;
        this.path.beginY = e.changedTouches[0].clientY - this.stage_info.top;

        // console.log('start', e.changedTouches, e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        // console.log(this.path.beginX, e.changedTouches[0].clientX, this.stage_info.left);
        // console.log(this.path.beginY, e.changedTouches[0].clientY, this.stage_info.top);
        this.canvas.addEventListener("touchmove", function(event) {
          event.preventDefault();
          that.drawing(event)
        });
      }

      drawing(e) {
        this.stage_info = this.canvas.getBoundingClientRect();
        this.cxt.lineTo(
          e.changedTouches[0].clientX - this.stage_info.left,
          e.changedTouches[0].clientY - this.stage_info.top
        )
        this.path.endX = e.changedTouches[0].clientX - this.stage_info.left
        this.path.endY = e.changedTouches[0].clientY - this.stage_info.top
        // console.log('drawing', e.changedTouches, e.changedTouches[0].clientX, e.changedTouches[0].clientY);
        this.cxt.stroke()
      }

      drawEnd() {
        document.removeEventListener('touchstart', preHandler, false);
        document.removeEventListener('touchend', preHandler, false);
        document.removeEventListener('touchmove', preHandler, false);
        //canvas.ontouchmove = canvas.ontouchend = null
      }

      clear(btn) {
        this.cxt.clearRect(0, 0, this.width, this.height);
        this.renderMark();
      }
      
      save() {
        return this.canvas.toDataURL("image/png");
      }
    }
  </script>

	<script>
    new Vue({
      el: '#app',
      data: function(){
        return {
          isLoading: false,
          hasError: false,
          isOperationShow: false,
          isOperationDlgShow: false,
          billid: Utils.getQueryString('billid'),
          checkman: Utils.getQueryString('checkman'),
          billType: Utils.getQueryString('pk_billtype'),
          pageType: Utils.getQueryString('pageType'),
          ischeck: Utils.getQueryString('ischeck'),
          origin: Utils.getQueryString('origin'),
          openId: '100104042005',
          signBase64: '',
          formData: {
            djrq: new Date().Format('yyyy-MM-dd'),
            bankaccount: '1',
            psnname: '张三',
            jdeptname: '工程部',
            deptname: '财务部',
            defitem2: '工程施工',
            amount: '1000',
          },
          opinionData: {
            checkResult: 'Y', //'Y'批准 'R'驳回
            checkNote: '批准',
            isLoading: false,
          }
        }
      },

      mounted: function () {
        FastClick.attach(document.body);

        this.$nextTick(() => {
          var container = document.querySelector('.canvas-container');
          var canvas = container.querySelector('canvas');
          var width = container.offsetWidth;
          var height = container.offsetHeight;
          // alert(height);
          draw = new Draw('canvas', width, height);
          draw.init();
        });
      },

      methods: {
        getStepClass: function(checkResult){
          var className = '';
          switch(checkResult) {
          case 'Y':
            className = 'weui-icon-success';
            break;
          case 'R':
            className = 'weui-icon-download';
            break;
          default:
            className = 'weui-icon-waiting';
          }
          return className;
        },

        getDetail: function(){
          var vm = this;

          if (this.billid && this.pageType) {
            // url参数正常 请求数据
            vm.isLoading = true;
            vm.hasError = false;

            $.getJSON('/modules/wechat/ydsp/BillDetail', {
              billid: this.billid,
              openId: this.openId,
              pk_billtype: this.billType,
            }).then(function(rsp) {
              console.log(rsp);
              if (rsp.result === 'Y') {
                rsp.rsData.details.forEach(function (item){
                  item.isShowOther = false;
                });
                vm.formData = rsp.rsData;
                vm.hasError = false; 
              } else {
                vm.hasError = true; 
              }
              vm.isLoading = false;
            }, function() {
              vm.hasError = true;
            });
          } else {
            vm.hasError = true;
          }
        },

        goBackList: function(vm) {
          window.location.href = (vm.pageType === 'employee' ? '/modules/wechat/ydsp/WfqdIndex' : '/modules/wechat/ydsp/WddbIndex') + '?openId=' + vm.openId;
        },

        handleOptBtnClick: function(checkResult){
          this.isOperationShow = false;
          this.isOperationDlgShow = true;
          this.opinionData.checkResult = checkResult;
          this.opinionData.checkNote = checkResult === 'Y' ? '批准' : '驳回到制单人';
          console.log('checkResult', checkResult);
        },

        handleDlgBtnConfirmClick: function(){
          var vm = this;
          vm.opinionData.isLoading = true;
          $.post('/modules/wechat/ydsp/Wddb_CZ', {
            billType: vm.billType,
            billID: vm.billid,
            checkman: vm.checkman,
            checkResult: vm.opinionData.checkResult,
            checkNote: vm.opinionData.checkNote,
          }, function(rsp) {
            console.log('post', rsp);
            vm.opinionData.isLoading = false;
            if (rsp.result === 'Y') {
              vm.isOperationDlgShow = false;
              vm.ischeck = 'Y';
              $('#toast').fadeIn(0).fadeOut(2000, function(){
                // originwindow.location.href = './borrowBillList.html?pageType=' + vm.pageType;
                vm.origin !== 'push' ? vm.goBackList(vm) : wx.closeWindow();
              });
            } else {
              alert(rsp.msg || '审批失败，请重试！');
            }
          }, 'json');
        },

        handleDlgBtnCancelClick: function(){
          this.isOperationDlgShow = false;
          this.opinionData.checkNote = '批准';
          this.opinionData.checkResult = 'Y';
        },

        handleShowOtherClick: function(item) {
          item.isShowOther = !item.isShowOther;
        },

        handlePageCloseClick: function() {
          this.origin === 'list' ? this.goBackList(this) : wx.closeWindow();
        },

        handleClearClick: function() {
          draw.clear();
        },

        handleSaveClick: function() {
          var data = draw.save();
          this.signBase64 = data;
          console.log(data)
        }
      }
    });
	</script>
</body>
</html>